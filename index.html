<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Americano Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e7f5c">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:8px}
h2{text-align:center;margin:8px 0}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,button,select{width:100%;padding:10px;margin-top:6px;font-size:16px}
button{background:#1e7f5c;color:#fff;border:none;border-radius:6px}
.secondary{background:#555}
.danger{background:#b00020}
.hidden{display:none}

.round{margin-top:14px}
.round h3{margin:6px 0}
.bye{font-style:italic;color:#666;margin-bottom:6px}

.match{background:#f1f1f1;padding:10px;border-radius:6px;margin-bottom:8px}
.match.locked{opacity:.6}
.matchhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:14px;color:#333}
.badge{background:#e6efe9;border-radius:999px;padding:4px 10px;font-weight:bold}

.scoreline{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:8px;
  align-items:center;
}
.team{text-align:center;font-weight:bold;word-break:break-word}
.score{font-size:26px;text-align:center}
.score input{width:64px;font-size:24px;text-align:center}

@media(max-width:600px){
  .scoreline{grid-template-columns:1fr}
  .score{font-size:32px}
}

.controls{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
.controls label{display:flex;align-items:center;gap:6px;font-size:14px}
.controls .mini{padding:8px 10px;font-size:14px;width:auto}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:6px;border-bottom:1px solid #ddd;text-align:center}
.check{color:#1e7f5c;font-weight:bold;font-size:18px}

/* PDF/Print: vis kun stilling */
@media print{
  body{background:#fff;padding:0}
  .box:not(#resultBox), #matchesBox, h2{display:none!important}
  #resultBox{display:block!important}
  #resultBox button{display:none!important}
}
</style>
</head>

<body>

<h2>Americano Padel</h2>

<div class="box">
<label>Turnering</label>
<select id="tournamentSelect"></select>

<input id="newTournamentName" placeholder="Ny turnering">
<button onclick="createTournament()">Opret ny turnering</button>

<div class="controls" style="margin-top:10px">
  <button class="mini secondary" onclick="exportTournament()">Eksportér turnering (JSON)</button>
  <label class="mini" style="background:#eee;border-radius:6px">
    Importér
    <input type="file" accept=".json" onchange="importTournament(event)" style="display:none">
  </label>
</div>
</div>

<div class="box">
<label>Antal spillere</label>
<input type="number" id="playerCount" value="8" min="4">
<label>Antal baner</label>
<input type="number" id="courtCount" value="2" min="1">
<label>Point pr. kamp</label>
<input type="number" id="maxPoints" value="32" min="1">
<button onclick="initPlayers()">Opret spillere</button>
</div>

<div class="box hidden" id="playersBox">
<div id="players"></div>
<button onclick="generateProgram()">Opret program</button>
</div>

<div class="box hidden" id="matchesBox">
<h3>Kampprogram</h3>
<div id="matches"></div>

<div class="controls">
  <button class="mini danger" onclick="resetTournament()">Reset turnering (scores)</button>
</div>
</div>

<div class="box hidden" id="resultBox">
<h3>Stilling</h3>
<table>
<thead>
<tr>
<th>Spiller</th>
<th>Point</th>
<th>Vundne</th>
<th>Kampe</th>
<th>Snit</th>
<th>Oversidder</th>
</tr>
</thead>
<tbody id="resultat"></tbody>
</table>

<div class="controls">
  <button class="mini secondary" onclick="exportPDF()">Eksportér stilling (PDF)</button>
  <button class="mini danger" onclick="deleteTournament()">Slet turnering</button>
</div>
</div>

<script>
if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js");}

let tournaments = JSON.parse(localStorage.getItem("tournaments")||"{}");
let current = localStorage.getItem("currentTournament")||null;

function saveAll(){
  localStorage.setItem("tournaments",JSON.stringify(tournaments));
  if(current) localStorage.setItem("currentTournament",current);
  else localStorage.removeItem("currentTournament");
}

function ensureCurrent(){
  const keys = Object.keys(tournaments);
  if((!current || !tournaments[current]) && keys.length){
    current = keys[0];
    saveAll();
  }
}

/* ===== TURNERINGER ===== */
function refreshSelect(){
  tournamentSelect.innerHTML="";
  Object.keys(tournaments).forEach(n=>{
    const o=document.createElement("option");
    o.value=n;o.textContent=n;
    tournamentSelect.appendChild(o);
  });
  if(current && tournaments[current]) tournamentSelect.value=current;
}

tournamentSelect.onchange=()=>{
  current=tournamentSelect.value;
  saveAll();
  hydrate();
};

function createTournament(){
  const name=newTournamentName.value.trim();
  if(!name||tournaments[name])return alert("Ugyldigt navn");
  tournaments[name]={players:[],matches:[],scores:[],locks:[],TOTAL:32,COURTS:2};
  current=name;
  saveAll();refreshSelect();hydrate();
}

function deleteTournament(){
  if(!confirm("Slet turnering?")) return;

  delete tournaments[current];

  const keys = Object.keys(tournaments);
  current = keys.length ? keys[0] : null;

  saveAll();

  if(current){
    refreshSelect();
    hydrate();
  } else {
    refreshSelect();
    players.innerHTML=""; matches.innerHTML=""; resultat.innerHTML="";
    playersBox.classList.add("hidden");
    matchesBox.classList.add("hidden");
    resultBox.classList.add("hidden");
  }
}

/* ===== IMPORT/EXPORT TURNERING ===== */
function exportTournament(){
  if(!current) return;
  const blob=new Blob([JSON.stringify(tournaments[current])],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=current+".json";
  a.click();
}

function importTournament(event){
  const f=event.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const name=f.name.replace(".json","");
    tournaments[name]=JSON.parse(r.result);

    // defaults / bagudkompatibilitet
    const t=tournaments[name];
    t.players ||= [];
    t.matches ||= [];
    t.scores ||= [];
    t.locks ||= [];
    t.TOTAL ||= 32;
    t.COURTS ||= 2;

    current=name;
    saveAll();
    ensureCurrent();
    refreshSelect();
    hydrate();
  };
  r.readAsText(f);
}

/* ===== HYDRATE ===== */
function hydrate(){
  const t=tournaments[current];
  if(!t){
    playersBox.classList.add("hidden");
    matchesBox.classList.add("hidden");
    resultBox.classList.add("hidden");
    return;
  }

  t.players ||= [];
  t.matches ||= [];
  t.scores ||= [];
  t.locks ||= [];
  t.TOTAL ||= Number(maxPoints.value) || 32;
  t.COURTS ||= Number(courtCount.value) || 1;

  // sæt inputs, så UI afspejler turneringen
  maxPoints.value = t.TOTAL;
  courtCount.value = t.COURTS;

  players.innerHTML="";
  matches.innerHTML="";
  resultat.innerHTML="";

  t.players.forEach(p=>{
    const inp=document.createElement("input");
    inp.value=p.name;
    inp.oninput=()=>{
      p.name=inp.value;
      saveAll();
      render(); // navneændring -> fuld render ok
    };
    players.appendChild(inp);
  });

  if(t.players.length) playersBox.classList.remove("hidden");
  render();
}

/* ===== SPILLERE ===== */
function initPlayers(){
  const t=tournaments[current];
  if(!t) return alert("Opret turnering først");

  t.players=[];
  const base=Date.now();
  for(let i=0;i<playerCount.value;i++){
    t.players.push({id:`p-${base}-${i}`,name:`Spiller ${i+1}`});
  }

  t.matches=[]; t.scores=[]; t.locks=[];
  t.TOTAL = Number(maxPoints.value) || 32;
  t.COURTS = Math.max(1, Number(courtCount.value) || 1);

  saveAll();
  hydrate();
}

/* ===== PROGRAMGENERERING MED ANTAL BANER =====
   Vi laver "super-runder" via circle method (round-robin par) og splitter
   hver super-runde op i flere tids-slots afhængigt af COURTS.
   Hver tids-slot = "Runde X" i UI (og bye tæller pr. tids-slot).
*/
function generateProgram(){
  const t=tournaments[current];

  t.TOTAL = Number(maxPoints.value) || 32;
  t.COURTS = Math.max(1, Number(courtCount.value) || 1);

  const ids=t.players.map(p=>p.id);
  if(ids.length < 4) return alert("Mindst 4 spillere");

  // Hvis ulige antal, tilføj en "ghost" (sidder over i par-generationen)
  const hasGhost = (ids.length % 2 === 1);
  const ghost = "__GHOST__";
  const list = hasGhost ? ids.concat([ghost]) : ids.slice();
  const n=list.length;

  const fixed=list[0];
  let rest=list.slice(1);

  const timeSlots=[]; // hver slot: { round, court, h:[..], u:[..] }

  let slotRound = 1;

  // n-1 super-runder
  for(let r=0;r<n-1;r++){
    const rp=[fixed,...rest];

    // lav par (n/2 par)
    const pairs=[];
    for(let i=0;i<n/2;i++){
      const a=rp[i], b=rp[n-1-i];
      pairs.push([a,b]);
    }

    // fjern ghost-par og par der indeholder ghost
    const realPairs = pairs.filter(p=>p[0]!==ghost && p[1]!==ghost);

    // gruppér to par ad gangen til en kamp (4 spillere)
    const matches=[];
    for(let i=0;i<realPairs.length;i+=2){
      if(realPairs[i+1]){
        matches.push({h:realPairs[i], u:realPairs[i+1]});
      }
    }

    // split matches ud på tids-slots med COURTS pr slot
    for(let start=0; start<matches.length; start += t.COURTS){
      const slice = matches.slice(start, start+t.COURTS);
      slice.forEach((m,idx)=>{
        timeSlots.push({
          round: slotRound,
          court: idx+1,
          h: m.h,
          u: m.u
        });
      });
      slotRound++;
    }

    // roter rest
    rest.unshift(rest.pop());
  }

  t.matches = timeSlots;
  t.scores = Array(timeSlots.length).fill(null);
  t.locks  = Array(timeSlots.length).fill(false);

  saveAll();
  render();
}

function getName(id){
  const p=tournaments[current].players.find(p=>p.id===id);
  return p?p.name:"?";
}

/* ===== RENDER ===== */
function render(){
  const t=tournaments[current];
  if(!t || !t.matches.length){
    matchesBox.classList.add("hidden");
    resultBox.classList.add("hidden");
    return;
  }

  matches.innerHTML="";

  const rounds=[...new Set(t.matches.map(m=>m.round))];

  rounds.forEach(r=>{
    const idx=t.matches.map((m,i)=>m.round===r?i:null).filter(i=>i!==null);

    // hvem spiller i denne tids-slot?
    const played=new Set();
    idx.forEach(i=>{
      t.matches[i].h.forEach(id=>played.add(id));
      t.matches[i].u.forEach(id=>played.add(id));
    });
    const byes=t.players.filter(p=>!played.has(p.id)).map(p=>p.name);

    matches.innerHTML+=`
      <div class="round">
        <h3>Runde ${r}</h3>
        ${byes.length?`<div class="bye">Sidder over: ${byes.join(", ")}</div>`:""}
      </div>`;

    // kampe pr bane
    idx.forEach(i=>{
      const m=t.matches[i];
      const locked=!!t.locks[i];
      matches.innerHTML+=`
      <div class="match ${locked?'locked':''}">
        <div class="matchhead">
          <span class="badge">Bane ${m.court}</span>
          <label><input type="checkbox" ${locked?'checked':''} onchange="toggleLock(${i},this.checked)"> Lås kamp</label>
        </div>
        <div class="scoreline">
          <div class="team">${m.h.map(getName).join(" & ")}</div>
          <div class="score">
            <input type="number"
              ${locked?'disabled':''}
              value="${t.scores[i] ?? ""}"
              oninput="indtast(${i},this.value)">
            –
            <span id="away-${current}-${i}">
              ${t.scores[i]!=null ? t.TOTAL - t.scores[i] : ""}
            </span>
          </div>
          <div class="team">${m.u.map(getName).join(" & ")}</div>
        </div>
      </div>`;
    });
  });

  beregn();
  matchesBox.classList.remove("hidden");
  resultBox.classList.remove("hidden");
}

/* ===== LÅS KAMP ===== */
function toggleLock(i,val){
  const t=tournaments[current];
  t.locks[i]=!!val;
  saveAll();
  render();
}

/* ===== SCORE INPUT (live away-score) ===== */
function indtast(i,v){
  const t=tournaments[current];
  if(t.locks[i]) return;

  const span=document.getElementById(`away-${current}-${i}`);

  if(v===""){
    t.scores[i]=null;
    if(span) span.textContent="";
    saveAll();
    beregn();
    return;
  }

  v=Math.max(0,Math.min(t.TOTAL,Number(v)));
  t.scores[i]=v;
  if(span) span.textContent=t.TOTAL - v;

  saveAll();
  beregn();
}

/* ===== RESET TURNERING (scores + locks) ===== */
function resetTournament(){
  const t=tournaments[current];
  if(!t || !t.matches.length) return;
  if(!confirm("Resetter alle resultater og låse?")) return;

  t.scores = t.scores.map(()=>null);
  t.locks  = t.locks.map(()=>false);
  saveAll();
  render();
}

/* ===== STILLLING + OVERSIDDER (bye-point kun når hele runden er færdig) ===== */
function beregn(){
  const t=tournaments[current];
  if(!t) return;

  let pts={},wins={},games={},overs={};
  t.players.forEach(p=>{
    pts[p.id]=0; wins[p.id]=0; games[p.id]=0; overs[p.id]=false;
  });

  // Kamp-point
  t.matches.forEach((m,i)=>{
    if(t.scores[i]==null) return;
    const h=t.scores[i], u=t.TOTAL-h;
    m.h.forEach(id=>{pts[id]+=h; games[id]++;});
    m.u.forEach(id=>{pts[id]+=u; games[id]++;});
    if(h>u) m.h.forEach(id=>wins[id]++);
    if(u>h) m.u.forEach(id=>wins[id]++);
  });

  // Bye pr. tids-slot (runde) – kun når alle baner i runden har score
  const rounds=[...new Set(t.matches.map(m=>m.round))];
  rounds.forEach(r=>{
    const idx=t.matches.map((m,i)=>m.round===r?i:null).filter(i=>i!==null);

    // runden er afsluttet når ALLE kampe i denne tids-slot har score
    if(idx.length && idx.every(i=>t.scores[i]!=null)){
      const played=new Set();
      idx.forEach(i=>{
        t.matches[i].h.forEach(id=>played.add(id));
        t.matches[i].u.forEach(id=>played.add(id));
      });
      t.players.filter(p=>!played.has(p.id)).forEach(p=>{
        pts[p.id]+=t.TOTAL/2;
        games[p.id]+=1;        // bye tæller som kamp i snit
        overs[p.id]=true;
      });
    }
  });

  resultat.innerHTML = t.players
    .slice()
    .sort((a,b)=>pts[b.id]-pts[a.id] || wins[b.id]-wins[a.id])
    .map(p=>`
      <tr>
        <td>${p.name}</td>
        <td>${pts[p.id]}</td>
        <td>${wins[p.id]}</td>
        <td>${games[p.id]}</td>
        <td>${games[p.id]?(pts[p.id]/games[p.id]).toFixed(1):"-"}</td>
        <td>${overs[p.id]?'<span class="check">✓</span>':""}</td>
      </tr>
    `).join("");
}

/* ===== PDF EXPORT (stilling) ===== */
function exportPDF(){ window.print(); }

/* ===== INIT ===== */
ensureCurrent();
refreshSelect();
if(current && tournaments[current]) hydrate();
</script>

</body>
</html>
