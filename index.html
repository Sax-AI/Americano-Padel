<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Americano Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e7f5c">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:8px}
h2{text-align:center;margin:8px 0}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,button,select{width:100%;padding:10px;margin-top:6px;font-size:16px}
button{background:#1e7f5c;color:#fff;border:none;border-radius:6px}
.secondary{background:#555}
.danger{background:#b00020}
.hidden{display:none}

/* Runder */
.round{margin-top:14px}
.round h3{margin:6px 0}
.bye{font-style:italic;color:#666;margin-bottom:6px}

/* Kamp */
.match{background:#f1f1f1;padding:10px;border-radius:6px;margin-bottom:8px}
.match.locked{opacity:.6}

/* Desktop/iPad */
.scoreline{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  gap:8px;
}
.team{text-align:center;font-weight:bold;word-break:break-word}
.score{font-size:26px;text-align:center}
.score input{width:64px;font-size:24px;text-align:center}

/* Mobil (iPhone) */
@media(max-width:600px){
  .scoreline{
    grid-template-columns:1fr;
    gap:4px;
  }
  .score{font-size:32px}
  .team{font-size:16px}
}

.controls{margin-top:6px;font-size:14px}
.controls label{display:flex;align-items:center;gap:6px}

/* Tabel */
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:6px;border-bottom:1px solid #ddd;text-align:center}
.check{color:#1e7f5c;font-weight:bold;font-size:18px}
.edit{font-size:12px;color:#1e7f5c;cursor:pointer}
</style>
</head>

<body>

<h2>Americano Padel</h2>

<div class="box">
<label>Turnering</label>
<select id="tournamentSelect"></select>

<input id="newTournamentName" placeholder="Ny turnering">
<button onclick="createTournament()">Opret ny turnering</button>

<button class="secondary" onclick="exportTournament()">Eksportér</button>
<input type="file" accept=".json" onchange="importTournament(event)">
</div>

<div class="box">
<label>Antal spillere</label>
<input type="number" id="playerCount" value="8" min="4">
<label>Antal baner</label>
<input type="number" id="courtCount" value="2" min="1">
<label>Point pr. kamp</label>
<input type="number" id="maxPoints" value="32" min="1">
<button onclick="opretSpillere()">Opret spillere</button>
</div>

<div class="box hidden" id="playersBox">
<div id="players"></div>
<button onclick="lavAmericano()">Opret program</button>
</div>

<div class="box hidden" id="matchesBox">
<h3>Kampprogram</h3>
<div id="matches"></div>
</div>

<div class="box hidden" id="resultBox">
<h3>Stilling</h3>
<table>
<thead>
<tr>
<th>Spiller</th><th>Point</th><th>Vundne</th><th>Kampe</th><th>Snit</th><th>Oversidder</th>
</tr>
</thead>
<tbody id="resultat"></tbody>
</table>
<button class="danger" onclick="deleteTournament()">Slet turnering</button>
</div>

<script>
if("serviceWorker"in navigator){navigator.serviceWorker.register("sw.js")}

/* ===== STATE ===== */
let tournaments=JSON.parse(localStorage.getItem("tournaments")||"{}")
let current=null

/* ===== TURNERING ===== */
function createTournament(){
  const name=newTournamentName.value.trim()
  if(!name||tournaments[name])return alert("Ugyldigt navn")
  tournaments[name]={players:[],matches:[],scores:[],locks:[],TOTAL:32}
  saveAll();loadTournament(name)
}

function loadTournament(name){
  current=name
  tournamentSelect.value=name
  hydrate()
}

function hydrate(){
  const t=tournaments[current]
  if(!t)return
  window.players=t.players
  window.matchesData=t.matches
  window.scores=t.scores
  window.locks=t.locks
  window.TOTAL=t.TOTAL
  document.getElementById("matches").innerHTML=""
  render()
}

function save(){
  tournaments[current]={players, matches:matchesData, scores, locks, TOTAL}
  saveAll()
}
function saveAll(){localStorage.setItem("tournaments",JSON.stringify(tournaments))}

/* ===== UI ===== */
function refreshSelect(){
  tournamentSelect.innerHTML=""
  Object.keys(tournaments).forEach(n=>{
    const o=document.createElement("option");o.value=n;o.textContent=n
    tournamentSelect.appendChild(o)
  })
  tournamentSelect.onchange=()=>loadTournament(tournamentSelect.value)
}
refreshSelect()
if(tournamentSelect.options.length)loadTournament(tournamentSelect.options[0].value)

/* ===== SPILLERE ===== */
function opretSpillere(){
  players=[]
  playersDiv.innerHTML=""
  for(let i=0;i<playerCount.value;i++){
    players.push({id:i,name:"Spiller "+(i+1)})
    playersDiv.innerHTML+=`<input value="${players[i].name}" oninput="rename(${i},this.value)">`
  }
  playersBox.classList.remove("hidden")
}

function rename(id,val){
  players[id].name=val||players[id].name
  save();render()
}

/* ===== PROGRAM ===== */
function lavAmericano(){
  TOTAL=Number(maxPoints.value)
  matchesData=[];scores=[];locks=[]
  const n=players.length
  let fixed=players[0],rest=players.slice(1),round=1

  for(let r=0;r<n-1;r++){
    let rp=[fixed,...rest]
    let pairs=[]
    for(let i=0;i<Math.floor(n/2);i++){
      pairs.push([rp[i].id,rp[n-1-i].id])
    }
    for(let i=0;i<pairs.length;i+=2){
      if(pairs[i+1]){
        matchesData.push({h:pairs[i],u:pairs[i+1],round})
        scores.push(null);locks.push(false)
      }
    }
    round++;rest.unshift(rest.pop())
  }
  save();render()
}

/* ===== RENDER ===== */
function render(){
  if(!current||!matchesData)return
  matches.innerHTML=""
  const rounds=[...new Set(matchesData.map(m=>m.round))]

  rounds.forEach(r=>{
    const idx=matchesData.map((m,i)=>m.round===r?i:null).filter(i=>i!==null)
    const played=new Set()
    idx.forEach(i=>{
      matchesData[i].h.forEach(id=>played.add(id))
      matchesData[i].u.forEach(id=>played.add(id))
    })
    const byes=players.filter(p=>!played.has(p.id)).map(p=>p.name)

    matches.innerHTML+=`<div class="round"><h3>Runde ${r}</h3>${byes.length?`<div class="bye">Sidder over: ${byes.join(", ")}</div>`:""}</div>`

    idx.forEach(i=>{
      const m=matchesData[i]
      matches.innerHTML+=`
      <div class="match ${locks[i]?'locked':''}">
        <div class="scoreline">
          <div class="team">${m.h.map(id=>players[id].name).join(" & ")}</div>
          <div class="score">
            <input type="number" ${locks[i]?'disabled':''}
              value="${scores[i]??""}"
              oninput="indtast(${i},this.value)">
            – <span id="away${i}">${scores[i]!=null?TOTAL-scores[i]:""}</span>
          </div>
          <div class="team">${m.u.map(id=>players[id].name).join(" & ")}</div>
        </div>
        <div class="controls">
          <label><input type="checkbox" ${locks[i]?'checked':''}
            onchange="toggleLock(${i},this.checked)"> Lås kamp</label>
        </div>
      </div>`
    })
  })
  beregn()
  matchesBox.classList.remove("hidden")
}

/* ===== SCORE ===== */
function indtast(i,v){
  if(v===""){scores[i]=null;document.getElementById("away"+i).innerText="";beregn();save();return}
  v=Math.max(0,Math.min(TOTAL,Number(v)))
  scores[i]=v
  document.getElementById("away"+i).innerText=TOTAL-v
  beregn();save()
}
function toggleLock(i,val){locks[i]=val;save();render()}

/* ===== STILLLING ===== */
function beregn(){
  let pts={},wins={},games={},overs={}
  players.forEach(p=>{pts[p.id]=0;wins[p.id]=0;games[p.id]=0;overs[p.id]=false})

  matchesData.forEach((m,i)=>{
    if(scores[i]==null)return
    const h=scores[i],u=TOTAL-h
    m.h.forEach(id=>{pts[id]+=h;games[id]++})
    m.u.forEach(id=>{pts[id]+=u;games[id]++})
    if(h>u)m.h.forEach(id=>wins[id]++)
    if(u>h)m.u.forEach(id=>wins[id]++)
  })

  const rounds=[...new Set(matchesData.map(m=>m.round))]
  rounds.forEach(r=>{
    const idx=matchesData.map((m,i)=>m.round===r?i:null).filter(i=>i!==null)
    if(idx.every(i=>scores[i]!=null)){
      const played=new Set()
      idx.forEach(i=>{
        matchesData[i].h.forEach(id=>played.add(id))
        matchesData[i].u.forEach(id=>played.add(id))
      })
      players.filter(p=>!played.has(p.id)).forEach(p=>{
        pts[p.id]+=TOTAL/2;games[p.id]++;overs[p.id]=true
      })
    }
  })

  resultat.innerHTML=players
    .sort((a,b)=>pts[b.id]-pts[a.id]||wins[b.id]-wins[a.id])
    .map(p=>`
      <tr>
        <td>${p.name}</td>
        <td>${pts[p.id]}</td>
        <td>${wins[p.id]}</td>
        <td>${games[p.id]}</td>
        <td>${games[p.id]?(pts[p.id]/games[p.id]).toFixed(1):"-"}</td>
        <td>${overs[p.id]?'<span class="check">✓</span>':""}</td>
      </tr>`).join("")
  resultBox.classList.remove("hidden")
}

/* ===== EXPORT / IMPORT ===== */
function exportTournament(){
  const blob=new Blob([JSON.stringify(tournaments[current])],{type:"application/json"})
  const a=document.createElement("a")
  a.href=URL.createObjectURL(blob);a.download=current+".json";a.click()
}
function importTournament(e){
  const f=e.target.files[0];if(!f)return
  const r=new FileReader()
  r.onload=()=>{tournaments[f.name.replace(".json","")]=JSON.parse(r.result);saveAll();location.reload()}
  r.readAsText(f)
}
function deleteTournament(){
  if(confirm("Slet turnering?")){delete tournaments[current];saveAll();location.reload()}
}
</script>

</body>
</html>
